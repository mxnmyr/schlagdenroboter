<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Verwaltung - Game Station</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #b1cb21 0%, #7a9615 100%);
			min-height: 100vh;
			padding: 20px;
			color: #333;
		}
		.header { text-align: center; margin-bottom: 30px; padding-top: 20px; }
		h1 { color: white; font-size: 2.8em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px; }
		.subtitle { color: rgba(255, 255, 255, 0.9); font-size: 1.2em; }
		.container { max-width: 1200px; margin: 0 auto; }
		.admin-section { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
		.section-title { font-size: 1.8em; color: #333; margin-bottom: 20px; border-bottom: 3px solid #b1cb21; padding-bottom: 10px; }
		
		table { width: 100%; border-collapse: collapse; margin-top: 20px; }
		th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
		th { background-color: #b1cb21; color: white; font-weight: 600; }
		tr:hover { background-color: #f5f5f5; }
		
		.status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
		.status-complete { background: #4caf50; color: white; }
		.status-incomplete { background: #ff9800; color: white; }
		.status-unnamed { background: #f44336; color: white; }
		
		.game-stats { font-size: 0.9em; color: #666; }
		.game-stats span { margin-right: 15px; }
		
		.btn { display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #b1cb21 0%, #8fa619 100%); color: white; text-decoration: none; border-radius: 20px; font-size: 0.9em; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: transform 0.2s; border: none; cursor: pointer; margin: 2px; }
		.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
		.btn-small { padding: 8px 15px; font-size: 0.85em; }
		.btn-danger { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
		.btn-back { background: linear-gradient(135deg, #7a9615 0%, #5a6f10 100%); padding: 15px 35px; font-size: 1.1em; }
		
		.form-inline { display: flex; gap: 10px; align-items: center; }
		.form-inline input { padding: 8px 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.9em; }
		.form-inline input:focus { outline: none; border-color: #b1cb21; }
		
		.buttons { text-align: center; margin-top: 30px; }
		
		@media (max-width: 768px) {
			table { font-size: 0.85em; }
			.form-inline { flex-direction: column; align-items: stretch; }
		}
	</style>
</head>
<body>
	<div class="header">
		<h1>âš™ï¸ Verwaltung</h1>
		<div class="subtitle">NFC-Chip Verwaltung & Urkunden</div>
	</div>
	
	<div class="container">
		<!-- Live NFC-Scanner -->
		<div class="admin-section" style="background: linear-gradient(135deg, #f0f8e8 0%, #e8f5d8 100%); border: 3px solid #b1cb21;">
			<h2 class="section-title" style="color: #5a6f10;">ğŸ“¡ Live NFC-Scanner</h2>
			
			<div style="text-align: center;">
				<div id="scannerStatus" style="margin-bottom: 20px; font-size: 1.2em; font-weight: 600;">
					â¸ï¸ Scanner gestoppt
				</div>
				
				<div style="margin-bottom: 20px;">
					<button id="startScanBtn" class="btn" style="padding: 15px 40px; font-size: 1.1em;">
						â–¶ï¸ Scanner starten
					</button>
					<button id="stopScanBtn" class="btn btn-danger" style="padding: 15px 40px; font-size: 1.1em; display: none;">
						â¸ï¸ Scanner stoppen
					</button>
				</div>
				
				<div id="scanResult" style="background: white; border-radius: 10px; padding: 20px; min-height: 100px; display: none;">
					<div style="font-size: 1.5em; margin-bottom: 10px;">
						<strong>ğŸ¯ NFC-Tag erkannt!</strong>
					</div>
					<div style="font-size: 1.2em; color: #b1cb21; margin-bottom: 15px;">
						<strong id="scannedNfcId"></strong>
					</div>
					<div id="scanPlayerInfo" style="color: #666; margin-bottom: 20px;"></div>
					
					<!-- Schnell-Zuweisung -->
					<form id="quickAssignForm" style="display: none; margin-top: 20px;">
						<input type="text" id="quickNameInput" placeholder="Spielername eingeben" required style="padding: 12px 20px; border: 2px solid #b1cb21; border-radius: 5px; font-size: 1em; min-width: 300px; margin-right: 10px;">
						<button type="submit" id="quickAssignBtn" class="btn">âœ… Namen zuweisen</button>
					</form>
					
					<!-- Schnell-LÃ¶schen -->
					<form id="quickDeleteForm" style="display: none; margin-top: 15px;">
						<button type="submit" class="btn btn-small btn-danger">ğŸ—‘ï¸ Chip lÃ¶schen</button>
					</form>
				</div>
				
				<div style="margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 10px; border-left: 4px solid #ff9800;">
					<strong>ğŸ’¡ Hinweis:</strong> Arduino mit NFC-Reader muss am Computer angeschlossen und konfiguriert sein.<br>
					Alternative: NFC-ID manuell unten eingeben.
				</div>
			</div>
		</div>
		
		<div class="admin-section">
			<h2 class="section-title">â• NFC-Chip manuell hinzufÃ¼gen</h2>
			<form method="POST" action="/admin/add_nfc" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
				<input type="text" name="nfc_id" placeholder="NFC-ID eingeben" required style="padding: 12px 20px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em; min-width: 250px;">
				<input type="text" name="name" placeholder="Spielername (optional)" style="padding: 12px 20px; border: 2px solid #ddd; border-radius: 5px; font-size: 1em; min-width: 250px;">
				<button type="submit" class="btn">â• HinzufÃ¼gen</button>
			</form>
		</div>
		
		<div class="admin-section">
			<h2 class="section-title">ğŸ“‹ NFC-Chip Ãœbersicht</h2>
			
			<table>
				<thead>
					<tr>
						<th>NFC-ID</th>
						<th>Spielername</th>
						<th>Status</th>
						<th>Spiele</th>
						<th>Aktionen</th>
					</tr>
				</thead>
				<tbody>
					{% if nfc_list %}
						{% for nfc in nfc_list %}
						<tr>
							<td><strong>{{ nfc.nfc_id }}</strong></td>
							<td>
								{% if nfc.has_name %}
									{{ nfc.name }}
								{% else %}
									<em style="color: #999;">Kein Name</em>
								{% endif %}
							</td>
							<td>
								{% if nfc.completed_all %}
									<span class="status-badge status-complete">âœ“ Alle Spiele</span>
								{% elif nfc.has_name %}
									<span class="status-badge status-incomplete">â³ In Bearbeitung</span>
								{% else %}
									<span class="status-badge status-unnamed">âš  Unbenannt</span>
								{% endif %}
							</td>
							<td class="game-stats">
								<span>ğŸ”¥ {{ nfc.games_played.heisser_draht }}</span>
								<span>ğŸ² {{ nfc.games_played.vier_gewinnt }}</span>
								<span>ğŸ§© {{ nfc.games_played.puzzle }}</span>
							</td>
							<td>
								<div style="display: flex; flex-wrap: wrap; gap: 5px; align-items: center;">
									<form method="POST" action="/admin/assign_name" class="form-inline" style="margin: 0;">
										<input type="hidden" name="nfc_id" value="{{ nfc.nfc_id }}">
										<input type="text" name="name" placeholder="Name eingeben" value="{{ nfc.name if nfc.has_name else '' }}" required>
										<button type="submit" class="btn btn-small">
											{% if nfc.has_name and (nfc.games_played.heisser_draht > 0 or nfc.games_played.vier_gewinnt > 0 or nfc.games_played.puzzle > 0) %}
												ğŸ”„ Neu zuweisen (Chip zurÃ¼cksetzen)
											{% elif nfc.has_name %}
												âœï¸ Ã„ndern
											{% else %}
												â• Zuweisen
											{% endif %}
										</button>
									</form>
									
									{% if nfc.completed_all %}
										<a href="/admin/certificate/{{ nfc.nfc_id }}" class="btn btn-small" target="_blank">ğŸ… Urkunde</a>
									{% endif %}
									
									<form method="POST" action="/admin/delete_nfc" style="margin: 0;" 
										  onsubmit="return confirm('Chip {{ nfc.nfc_id }}{% if nfc.has_name %} ({{ nfc.name }}){% endif %} wirklich lÃ¶schen?\n\n{% if nfc.games_played.heisser_draht > 0 or nfc.games_played.vier_gewinnt > 0 or nfc.games_played.puzzle > 0 %}âš ï¸ Achtung: Spieldaten werden ins Archiv verschoben und bleiben in Leaderboards sichtbar.{% else %}Keine Spieldaten vorhanden.{% endif %}');">
										<input type="hidden" name="nfc_id" value="{{ nfc.nfc_id }}">
										<button type="submit" class="btn btn-small btn-danger">ğŸ—‘ï¸ LÃ¶schen</button>
									</form>
								</div>
							</td>
						</tr>
						{% endfor %}
					{% else %}
						<tr>
							<td colspan="5" style="text-align: center; padding: 40px; color: #999;">
								Noch keine NFC-Chips registriert
							</td>
						</tr>
					{% endif %}
				</tbody>
			</table>
		</div>
		
		<!-- Leaderboard Reset -->
		<div class="admin-section" style="background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%); border: 3px solid #f44336;">
			<h2 class="section-title" style="color: #d32f2f;">ğŸ—‘ï¸ Leaderboard zurÃ¼cksetzen</h2>
			
			<div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
				<div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
					<strong>âš ï¸ Warnung:</strong> Beim ZurÃ¼cksetzen werden alle Spieldaten des gewÃ¤hlten Leaderboards gelÃ¶scht!<br>
					<strong>ğŸ’¾ Backup:</strong> Vor dem LÃ¶schen wird automatisch ein Backup erstellt.
				</div>
				
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
					<!-- HeiÃŸer Draht Reset -->
					<div style="background: #f0f8e8; border: 2px solid #b1cb21; border-radius: 10px; padding: 20px; text-align: center;">
						<div style="font-size: 2em; margin-bottom: 10px;">ğŸ”¥</div>
						<h3 style="margin-bottom: 10px; color: #5a6f10;">HeiÃŸer Draht</h3>
						<button onclick="resetLeaderboard('heisser_draht')" class="btn btn-danger" style="width: 100%;">
							ğŸ—‘ï¸ Reset
						</button>
					</div>
					
					<!-- Vier Gewinnt Reset -->
					<div style="background: #f0f8e8; border: 2px solid #b1cb21; border-radius: 10px; padding: 20px; text-align: center;">
						<div style="font-size: 2em; margin-bottom: 10px;">ğŸ²</div>
						<h3 style="margin-bottom: 10px; color: #5a6f10;">Vier Gewinnt</h3>
						<button onclick="resetLeaderboard('vier_gewinnt')" class="btn btn-danger" style="width: 100%;">
							ğŸ—‘ï¸ Reset
						</button>
					</div>
					
					<!-- Puzzle Reset -->
					<div style="background: #f0f8e8; border: 2px solid #b1cb21; border-radius: 10px; padding: 20px; text-align: center;">
						<div style="font-size: 2em; margin-bottom: 10px;">ğŸ§©</div>
						<h3 style="margin-bottom: 10px; color: #5a6f10;">Puzzle</h3>
						<button onclick="resetLeaderboard('puzzle')" class="btn btn-danger" style="width: 100%;">
							ğŸ—‘ï¸ Reset
						</button>
					</div>
					
					<!-- Alle Reset -->
					<div style="background: #ffebee; border: 3px solid #f44336; border-radius: 10px; padding: 20px; text-align: center;">
						<div style="font-size: 2em; margin-bottom: 10px;">ğŸ’£</div>
						<h3 style="margin-bottom: 10px; color: #d32f2f;">Alle Leaderboards</h3>
						<button onclick="resetLeaderboard('all')" class="btn btn-danger" style="width: 100%; font-weight: bold;">
							ğŸ’£ ALLE LÃ–SCHEN
						</button>
					</div>
				</div>
			</div>
		</div>
		
		<div class="admin-section">
			<h2 class="section-title">â„¹ï¸ Hinweise</h2>
			<ul style="line-height: 2; color: #555;">
				<li><strong>Neuen Chip hinzufÃ¼gen:</strong> NFC-ID und optional Namen im Formular oben eingeben</li>
				<li><strong>Namen zuweisen/Ã¤ndern:</strong> Namen direkt in der Tabelle eingeben und Button klicken</li>
				<li><strong>Spiele:</strong> ğŸ”¥ = HeiÃŸer Draht, ğŸ² = Vier Gewinnt, ğŸ§© = Puzzle</li>
				<li><strong>Urkunde:</strong> VerfÃ¼gbar wenn alle 3 Spiele abgeschlossen sind</li>
				<li><strong>Chip wiederverwenden:</strong> "ğŸ”„ Neu zuweisen" setzt Chip zurÃ¼ck (Leaderboard-Daten bleiben mit altem Namen erhalten)</li>
				<li><strong>Leaderboard-Daten:</strong> Werden mit dem aktuellen Spielernamen gespeichert und bleiben bei Chip-Neuzuweisung erhalten</li>
				<li><strong>Leaderboard Reset:</strong> Erstellt automatisch ein Backup vor dem LÃ¶schen</li>
			</ul>
		</div>
		
		<div class="buttons">
			<a href="/" class="btn btn-back">ğŸ”™ ZurÃ¼ck zur Ãœbersicht</a>
		</div>
	</div>
	
	<script>
		let scannerInterval = null;
		let lastScannedNfc = null;
		
		const startBtn = document.getElementById('startScanBtn');
		const stopBtn = document.getElementById('stopScanBtn');
		const statusDiv = document.getElementById('scannerStatus');
		const resultDiv = document.getElementById('scanResult');
		const scannedIdSpan = document.getElementById('scannedNfcId');
		const playerInfoDiv = document.getElementById('scanPlayerInfo');
		const quickForm = document.getElementById('quickAssignForm');
		const quickNameInput = document.getElementById('quickNameInput');
		const quickDeleteForm = document.getElementById('quickDeleteForm');
		
		// Scanner starten
		startBtn.addEventListener('click', () => {
			startScanner();
			startBtn.style.display = 'none';
			stopBtn.style.display = 'inline-block';
			statusDiv.innerHTML = 'ğŸŸ¢ Scanner aktiv - Halte NFC-Tag an den Leser...';
			statusDiv.style.color = '#4caf50';
		});
		
		// Scanner stoppen
		stopBtn.addEventListener('click', () => {
			stopScanner();
			stopBtn.style.display = 'none';
			startBtn.style.display = 'inline-block';
			statusDiv.innerHTML = 'â¸ï¸ Scanner gestoppt';
			statusDiv.style.color = '#666';
			resultDiv.style.display = 'none';
		});
		
		// Scanner-Funktion
		function startScanner() {
			// Polling alle 500ms nach neuem NFC-Scan
			scannerInterval = setInterval(async () => {
				try {
					const response = await fetch('/api/last_nfc_scan');
					const data = await response.json();
					
					// PrÃ¼fe ob neuer Scan vorliegt
					if (data.nfc_id && data.nfc_id !== lastScannedNfc) {
						processNfcScan(
							data.nfc_id, 
							data.player_name, 
							data.exists, 
							data.has_name
						);
					}
				} catch (error) {
					console.error('Polling-Fehler:', error);
				}
			}, 500);
		}
		
		function stopScanner() {
			if (scannerInterval) {
				clearInterval(scannerInterval);
				scannerInterval = null;
			}
		}
		
		// NFC-Scan manuell auslÃ¶sen (fÃ¼r Testing)
		function processNfcScan(nfcId, playerName = null, exists = false, hasName = false) {
			if (nfcId === lastScannedNfc) {
				return; // Verhindere Duplikate
			}
			
			lastScannedNfc = nfcId;
			
			// Ergebnis anzeigen
			resultDiv.style.display = 'block';
			scannedIdSpan.textContent = nfcId;
			
			const quickAssignBtn = document.getElementById('quickAssignBtn');
			
			if (hasName) {
				// Chip hat bereits einen Namen - Zeige Option zum Umbenennen + LÃ¶schen
				playerInfoDiv.innerHTML = `
					<div style="color: #4caf50; font-size: 1.1em;">
						âœ“ Chip bereits registriert: <strong>${playerName}</strong>
					</div>
					<div style="margin-top: 10px; color: #666;">
						Chip kann jetzt fÃ¼r Spiele verwendet werden.
					</div>
					<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
						<strong>ğŸ’¡ Namen Ã¤ndern?</strong><br>
						Gib einen neuen Namen ein und klicke auf "Namen Ã¤ndern"
					</div>
				`;
				quickForm.style.display = 'block';
				quickNameInput.value = playerName; // Aktuellen Namen vorausfÃ¼llen
				quickNameInput.focus();
				quickNameInput.select(); // Text markieren fÃ¼r schnelles Ãœberschreiben
				quickAssignBtn.innerHTML = 'âœï¸ Namen Ã¤ndern'; // Button-Text Ã¤ndern
				quickDeleteForm.style.display = 'block'; // LÃ¶sch-Button anzeigen
			} else {
				// Chip ist neu oder unbenannt
				playerInfoDiv.innerHTML = `
					<div style="color: #ff9800; font-size: 1.1em;">
						âš ï¸ Chip noch nicht benannt
					</div>
				`;
				quickForm.style.display = 'block';
				quickNameInput.value = '';
				quickNameInput.focus();
				quickAssignBtn.innerHTML = 'âœ… Namen zuweisen'; // Button-Text zurÃ¼cksetzen
				quickDeleteForm.style.display = 'block'; // LÃ¶sch-Button anzeigen (auch fÃ¼r unbenannte Chips)
			}
			
			// Nach 5 Sekunden ausblenden
			setTimeout(() => {
				lastScannedNfc = null;
			}, 5000);
		}
		
		// Schnell-Zuweisung
		quickForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			const name = quickNameInput.value.trim();
			const nfcId = scannedIdSpan.textContent;
			const quickAssignBtn = document.getElementById('quickAssignBtn');
			const isRename = quickAssignBtn.innerHTML.includes('Ã¤ndern');
			
			if (!name || !nfcId) return;
			
			// Namen zuweisen
			const formData = new FormData();
			formData.append('nfc_id', nfcId);
			formData.append('name', name);
			
			try {
				const response = await fetch('/admin/assign_name', {
					method: 'POST',
					body: formData
				});
				
				if (response.ok) {
					const action = isRename ? 'geÃ¤ndert' : 'zugewiesen';
					playerInfoDiv.innerHTML = `
						<div style="color: #4caf50; font-size: 1.1em;">
							âœ… Name erfolgreich ${action}: <strong>${name}</strong>
						</div>
					`;
					quickForm.style.display = 'none';
					
					// Seite nach 2 Sekunden neu laden
					setTimeout(() => {
						location.reload();
					}, 2000);
				}
			} catch (error) {
				alert('Fehler beim Zuweisen des Namens: ' + error);
			}
		});
		
		// Schnell-LÃ¶schen
		quickDeleteForm.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			const nfcId = scannedIdSpan.textContent;
			const playerName = quickNameInput.value || 'Unbenannt';
			
			if (!nfcId) return;
			
			// BestÃ¤tigung anfordern
			const confirmMsg = `Chip ${nfcId} (${playerName}) wirklich lÃ¶schen?\n\nâš ï¸ Achtung: Falls Spieldaten vorhanden sind, werden diese ins Archiv verschoben und bleiben in Leaderboards sichtbar.`;
			if (!confirm(confirmMsg)) return;
			
			// Chip lÃ¶schen
			const formData = new FormData();
			formData.append('nfc_id', nfcId);
			
			try {
				const response = await fetch('/admin/delete_nfc', {
					method: 'POST',
					body: formData
				});
				
				if (response.ok) {
					playerInfoDiv.innerHTML = `
						<div style="color: #4caf50; font-size: 1.1em;">
							âœ… Chip erfolgreich gelÃ¶scht: <strong>${nfcId}</strong>
						</div>
					`;
					quickForm.style.display = 'none';
					quickDeleteForm.style.display = 'none';
					
					// Seite nach 2 Sekunden neu laden
					setTimeout(() => {
						location.reload();
					}, 2000);
				}
			} catch (error) {
				alert('Fehler beim LÃ¶schen des Chips: ' + error);
			}
		});
		
		// Leaderboard zurÃ¼cksetzen
		async function resetLeaderboard(gameType) {
			const gameNames = {
				'heisser_draht': 'HeiÃŸer Draht',
				'vier_gewinnt': 'Vier Gewinnt',
				'puzzle': 'Puzzle',
				'all': 'ALLE LEADERBOARDS'
			};
			
			const gameName = gameNames[gameType] || gameType;
			
			// Doppelte BestÃ¤tigung fÃ¼r "Alle lÃ¶schen"
			if (gameType === 'all') {
				const firstConfirm = confirm(
					`âš ï¸ ACHTUNG: Du bist dabei, ALLE LEADERBOARDS zu lÃ¶schen!\n\n` +
					`Dies betrifft:\n` +
					`- ğŸ”¥ HeiÃŸer Draht\n` +
					`- ğŸ² Vier Gewinnt\n` +
					`- ğŸ§© Puzzle\n\n` +
					`Alle Spieldaten werden gelÃ¶scht (aber im Backup gespeichert).\n\n` +
					`Bist du SICHER, dass du fortfahren mÃ¶chtest?`
				);
				
				if (!firstConfirm) return;
				
				const secondConfirm = confirm(
					`âš ï¸ LETZTE WARNUNG!\n\n` +
					`Wirklich ALLE Leaderboards unwiderruflich lÃ¶schen?\n\n` +
					`(Ein Backup wird erstellt)`
				);
				
				if (!secondConfirm) return;
			} else {
				// Einfache BestÃ¤tigung fÃ¼r einzelne Leaderboards
				const confirm_msg = confirm(
					`Leaderboard "${gameName}" wirklich zurÃ¼cksetzen?\n\n` +
					`âš ï¸ Alle Spieldaten fÃ¼r dieses Spiel werden gelÃ¶scht!\n` +
					`ğŸ’¾ Ein Backup wird automatisch erstellt.`
				);
				
				if (!confirm_msg) return;
			}
			
			// Reset durchfÃ¼hren
			const formData = new FormData();
			formData.append('game_type', gameType);
			
			try {
				const response = await fetch('/admin/reset_leaderboard', {
					method: 'POST',
					body: formData
				});
				
				const result = await response.json();
				
				if (result.success) {
					alert(
						`âœ… ${result.message}\n\n` +
						`ğŸ’¾ Backup gespeichert: ${result.backup_file}`
					);
					location.reload();
				} else {
					alert('âŒ Fehler: ' + result.message);
				}
			} catch (error) {
				alert('âŒ Fehler beim ZurÃ¼cksetzen: ' + error);
			}
		}
		
		// Event-Listener fÃ¼r Arduino-Daten (Ã¼ber Server-Sent Events oder WebSocket)
		// FÃ¼r die Implementierung mit dem Arduino-Code siehe unten
	</script>
</body>
</html>
